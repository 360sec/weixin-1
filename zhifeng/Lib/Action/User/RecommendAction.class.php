<?phpclass RecommendAction extends UserAction{	public $Recommend;	public $token;	public function _initialize() {		parent::_initialize();			$this->canUseFunction('Recommend');				$this->Recommend = M('Recommend');		//$this->formdetaildb=M('Recommend_detail');		$this->userdb=M('Userinfo');		$this->logdb=M('Score_logs');				$this->token=session('token');		$this->acid=$this->_get('acid');				$this->assign('acid',$this->acid);		$this->assign('token',$this->token);	}	public function index(){		$where=array('token'=>$this->token,'status'=>1);		$count      = $this->Recommend->where($where)->order('id desc')->count();		$Page       = new Page($count,20);		$show       = $Page->show();		$data = $this->Recommend->where($where)->order('id asc')->limit($Page->firstRow.','.$Page->listRows)->select();					$this->assign('page',$show);		$this->assign('data',$data);		$this->display();	}	public function add(){		$_POST['token'] = $this->token;		//print_r($_POST);die;		if(IS_POST){		//编码zf：w z h		$_POST['content']=htmlspecialchars($_POST['content']);		$_POST['copyright']=htmlspecialchars($_POST['copyright']);		$_POST['time']=time();		if(!trim($_POST['author'])){			$_POST['author']=$this->wecha['wxname'];		}		if(empty($_POST['keyword'])){$this->error('关键字不能为空!',U('Recommend/index',array('token'=>$this->token)));}		if(empty($_POST['title'])){$this->error('标题不能为空!',U('Recommend/index',array('token'=>$this->token)));}			if($id=$this->Recommend->add($_POST)){				$keyword_model=M('Keyword');				$key = array(					'keyword'=>$_POST['keyword'],					'pid'=>$id,					'token'=>$this->token,					'module'=>'Recommend'				);				$keyword_model->add($key);				$this->success('添加成功！',U('Recommend/index',array('token'=>$this->token)));			}else{				$this->error('添加失败！',U('Recommend/index',array('token'=>$this->token)));			}		}else{			$this->display('set');		}	}	public function set(){		$id = intval($this->_get('id'));		$checkdata = $this->Recommend->where(array('id'=>$id))->find();		if(empty($checkdata)||$checkdata['token']!=$this->token){            $this->error("没有相应记录.您现在可以添加.",U('Recommend/add'));        }		if(IS_POST){             $id = $this->_post('id');			$where=array('id'=>$id,'token'=>$this->token);			$check=$this->Recommend->where($where)->find();			if($check==false)$this->error('非法操作');			//编码zf：w z h			$_POST['content']=htmlspecialchars($_POST['content']);			$_POST['copyright']=htmlspecialchars($_POST['copyright']);			if($this->Recommend->create()){				if($this->Recommend->where($where)->save($_POST)){							$keyword_model=M('Keyword');					$keyword_model->where(array('token'=>$this->token,'pid'=>$id,'module'=>'Recommend'))->save(array('keyword'=>$_POST['keyword']));					$this->success('修改成功',U('Recommend/index',array('token'=>$this->token)));				}else{					$this->error('操作失败');				}			}else{				$this->error($this->Recommend->getError());			}		}else{			$this->assign('isUpdate',1);			$this->assign('set',$checkdata);			$this->display();			}	}	public function del(){		if($this->_get('token')!=$this->token){			$this->error('非法操作!');		}        $id = intval($this->_get('id'));        if(IS_GET){            $where=array('id'=>$id,'token'=>$this->token);            $check=$this->Recommend->where($where)->find();            if($check==false)$this->error('非法操作');			//判断规则            $rule_del=M('Recommend_rule')->where(array('acid'=>$id))->find();			if($rule_del){				$this->error('此活动下还有规则未删除',U('Recommend/rule',array('token'=>$this->token,'acid'=>$id)));			}else{				$back = $this->Recommend->where($where)->delete();				if($back==true){					$this->success('操作成功',U('Recommend/index',array('token'=>$this->token)));				}else{					$this->error('服务器繁忙,请稍后再试',U('Recommend/index',array('token'=>$this->token)));				}					}							        }	}	//rule~~wzh	public function rule(){		$db=M('Recommend_rule');		$rulewhere['acid']=$this->_get('acid');		$rulewhere['token']=$this->token;		$count      = $db->where($rulewhere)->order('id desc')->count();		$Page       = new Page($count,20);		$show       = $Page->show();		$data =  $db->where($rulewhere)->order('id desc')->limit($Page->firstRow.','.$Page->listRows)->select();					$this->assign('page',$show);		$this->assign('data',$data);		$this->assign('acid',$rulewhere['acid']);		$this->display();	}		public function rule_set(){		$db=M('Recommend_rule');		$rulewhere['acid']=$this->_get('acid');		$rulewhere['token']=$this->token;		if($this->_get('id')){$rulewhere['id']=$this->_get('id');}		if(IS_POST){						$_POST['acid']=$rulewhere['acid'];			if(empty($_POST['id'])){				if($db->add($_POST)){					$this->success('规则添加成功',U('Recommend/rule',array('token'=>$this->token,'acid'=>$rulewhere['acid'])));				}else{$this->error('规则添加失败',U('Recommend/rule',array('token'=>$this->token,'acid'=>$rulewhere['acid'])));}			}else{				if($db->where(array('id'=>$_POST['id']))->save($_POST)){					$this->success('规则修改成功',U('Recommend/rule',array('token'=>$this->token,'acid'=>$rulewhere['acid'])));				}else{$this->error('规则修改失败',U('Recommend/rule',array('token'=>$this->token,'acid'=>$rulewhere['acid'])));}			}		}else{			$isUpdate = $this->_get('id')?1:0;			if($rulewhere['id']){							$set=$db->where($rulewhere)->find();				$this->assign('set',$set);			}			$this->assign('isUpdate',$isUpdate);			$this->display();		}	}	public function rule_del(){		$db=M('Recommend_rule');		$rulewhere['acid']=$this->_get('acid');		$rulewhere['token']=$this->token;		$rulewhere['id']=$this->_get('id')?$this->_get('id'):$this->error('操作错误',U('Recommend/rule',array('token'=>$this->token,'acid'=>$rulewhere['acid'])));		$db->where($rulewhere)->delete()?$this->success('推荐规则删除成功',U('Recommend/rule',array('token'=>$this->token,'acid'=>$rulewhere['acid']))):$this->error('推荐策略删除失败',U('Recommend/rule',array('token'=>$this->token,'acid'=>$rulewhere['acid'])));	}		//推荐记录	public function tj_logs(){		$acid=$this->_get('acid');		$logdb=$this->logdb;		$userdb=$this->userdb;		$where['token']=$this->token;		$where['scoretype']=2;		$where['acid']=$acid;		$count      =$logdb->where($where)->order('id desc')->count();		$Page       = new Page($count,20);		$show       = $Page->show();		//sousuo~wzh		if(IS_POST){			$_POST['seachkey'];			if($_POST['allsmtype']==2){				for ($i=0;$i<40;$i++){					if (isset($_POST['id_'.$i])){						$thiCartInfo=$logdb->where(array('id'=>intval($_POST['id_'.$i])))->delete();					}				}				$this->success('操作成功',U('Recommend/tj_logs',array('token'=>$this->token,'acid'=>$acid)));				exit;			}		}		$data =  $logdb->where($where)->order('id desc')->limit($Page->firstRow.','.$Page->listRows)->select();			foreach($data as $key=>$val){			$data[$key]['user']=$userdb->field('truename,tel')->where(array('id'=>$val['uid']))->find();		}	//	dump($data);exit;		$this->assign('page',$show);		$this->assign('data',$data);				$this->assign('acid',$acid);		$this->display();	}	//	function logs_del(){		$acid=$this->_get('acid');		$id=$this->_get('id');		$logdb=$this->logdb;		$delstatus=$logdb->where(array('id'=>$id,'acid'=>$acid))->delete();		if($delstatus){			$this->success(' 删除成功',U('Recommend/tj_logs',array('token'=>$this->token,'acid'=>$acid)));		}else{			$this->error(' 删除失败',U('Recommend/tj_logs',array('token'=>$this->token,'acid'=>$acid)));		}	}		//活动表单设置	/*public function forminfo(){		$acid=$this->acid;		if(!$acid){$this->error('未识别的活动！',U('Recommend/index',array('token'=>$this->token)));}		$db=$this->formdetaildb;		$lists=$db->where(array('acid'=>$acid,'token'=>$this->token))->select();		$this->assign('lists',$lists);		$this->display();	}	public function setinfo(){		$acid=$this->acid;		if(!$acid){$this->error('未识别的活动！',U('Recommend/index',array('token'=>$this->token)));}		$infoid==$this->get('id');		$db=$this->formdetaildb;		if(IS_POST){			$_POST['acid']=$acid;			$_POST['token']=$this->token;			if($_POST['id']){				$setinfo=$db->where(array('id'=>$_POST['id']))->save($_POST);				if($setinfo){					$this->success('保存成功',U('Recommend/forminfo',array('token'=>$this->token,'acid'=>$acid)));				}else{					$this->error('保存失败！请稍候重试！',U('Recommend/forminfo',array('token'=>$this->token,'acid'=>$acid)));				}			}else{				$setinfo=$db->add($_POST);				if($setinfo){					$this->success('添加成功',U('Recommend/forminfo',array('token'=>$this->token,'acid'=>$acid)));				}else{					$this->error('添加失败！请稍候重试！',U('Recommend/forminfo',array('token'=>$this->token,'acid'=>$acid)));				}			}		}else{			if($infoid){				$set=$db->where(array('id'=>$infoid))->find();				$this->assign('set',$set);			}		}		$this->display();	}*/}?>