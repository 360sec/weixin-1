<layout name="COMMON/html" />


<div> 






	<div> 
		<div>商品编辑</div> 
		<a href="{ZF::U('Product/product_list',array('token'=>$token,'catid'=>$catid))}">返回</a> 
	</div> 
	
	<if condition="$isUpdate eq 1">
		<input type="hidden" name="id" value="{ZF:$set.id}">
	</if>
	
	
	
	
	
	<form method="post" action="" id="formID" enctype="multipart/form-data">



<input type="hidden" name="discount" id="discount" value="{ZF:$set.discount}">
	
	
<div>
	*名称：
	<input type="hidden" name="pid" id="pid" value="{ZF:$set.id}">
	<input type="text" name="name" id="name" value="{ZF:$set.name}" style="width:400px;">
</div>



<div>
*商品类别：
{ZF:$productCatData.name}
</div>					
					
					
<div>					
*社区类目：
<select name="community_catid" id="community_catid">
    <volist name="wz_cates" id="vo">
      <option value="{ZF:$vo.id},{ZF:$vo.name}"<php> if ($set['community_catid'] == $vo['id']) echo ' selected="selected"';</php>>{ZF:$vo.name}</option>
    </volist>
</select>
<br>
<br/>选上后，商品可以在社区的商品搜索结果中。
<br/>如果这里没有可选项，原因可能有两个:
<br/>1、本公众号的所属帐号没有选择所在的社区；
<br/>2、或者暂时还没有社区站点数据。
</div>
	       
	       
	       
<!-- 外观属性  -->
<if condition="empty($productCatData['color']) neq true">
<div>
{ZF:$productCatData.color}：
<table>
     <tr>
      	<volist name="colorData" id="norms" key="i">
			<td width="130">
				<input type="checkbox" name="color[]" value="{ZF:$norms.id}" class="color NormItem" id="norms_{ZF:$norms.id}" atr="{ZF:$norms.value}"<if condition="(in_array($norms['id'], $colorList))"> checked="checked"</if>>&nbsp;&nbsp;<label for="norms_{ZF:$norms.id}">{ZF:$norms.value}</label>
			</td>
			<if condition="($i%5 eq 0)" ></tr><tr></if>
		</volist>
	</tr>
</table>
</div>
</if>
		       
		       
		       
<!-- 规格属性 -->
<if condition="empty($productCatData['norms']) neq true">
<div>
{ZF:$productCatData.norms}：
<table>
	<tr>
 		<volist name="formatData" id="norms" key="i">
			<td width="130">
				<input type="checkbox" name="norms[]" value="{ZF:$norms.id}" class="norms NormItem" id="norms_{ZF:$norms.id}" atr="{ZF:$norms.value}"<if condition="(in_array($norms['id'], $formatList))" > checked="checked"</if>>&nbsp;&nbsp;<label for="norms_{ZF:$norms.id}">{ZF:$norms.value}</label>
			</td>
			<if condition="($i%5 eq 0)" ></tr><tr></if>
		</volist>
	</tr>
</table>
</div>
</if>
		       


	       
<!-- 外观与规格的数据显示（相应的价格、会员价、库存） -->

<table id="priceList">
	<if condition="($productDetailData neq null) ">
	<tr><th width="130">产品外观</th><th width="130">产品规格</th><th width="130">价格</th><th width="130">会员价</th><th width="130">数量</th></tr>
       <volist name="productDetailData" id="detail">
			<input type="hidden" class="editselect" value="{ZF:$detail.id},{ZF:$detail.color},{ZF:$detail.colorName},{ZF:$detail.format},{ZF:$detail.formatName},{ZF:$detail.price},{ZF:$detail.vprice},{ZF:$detail.num}">
			<tr class="tnorms">
				<td width="130">{ZF:$detail.colorName}<input type="hidden" value="{ZF:$detail.color}"/></td>
				<td width="130">{ZF:$detail.formatName}<input type="hidden" value="{ZF:$detail.format}"/></td>
				<td width="130"><input type="text" class="px" style="width:60px;" value="{ZF:$detail.price}"/></td>
				<td width="130"><input type="text" class="px" style="width:60px;" value="{ZF:$detail.vprice}"/></td>
				<td width="130"><input type="text" class="px" style="width:60px;" value="{ZF:$detail.num}"/></td>
				<td width="130"><input type="hidden" value="{ZF:$detail.id}"/></td>
			</tr>
       </volist>
       </if>
</table>

		       
<!-- 自定义属性 -->
<div>
<volist name="attributeData" id="attribute">
	{ZF:$attribute.name}：
	<input type="text" value="{ZF:$attribute.value}" class="attribute px" style="width:400px;" atr="{ZF:$attribute.name}" id="{ZF:$attribute.id}" aid="{ZF:$attribute.aid}">
</volist>
</div>


<div>
*价格：
<input type="text" id="price" name="price" value="{ZF:$set.price}" class="validate[required, length[0,20]]" style="width:100px;"> 元
</div>


<div>
*会员价：
<input type="text" id="vprice" name="vprice" value="{ZF:$set.vprice}" style="width:100px;"> 元
</div>

<div>
*原价：
<input type="text" id="oprice" name="oprice" value="{ZF:$set.oprice}" style="width:100px;"> 元
</div>

<div>
库存：
<input type="text" id="num" name="num" value="{ZF:$set.num}" style="width:100px;">
</div>

<div>	        
邮费：
<input type="text" id="mailprice" name="mailprice" value="{ZF:$set.mailprice}" style="width:100px;">元
</div>

<div>
关键词：
<input type="text" name="keyword" id="keyword" value="{ZF:$set.keyword}" style="width:400px;">
</div>

<if condition="!empty($_GET['id'])"> <!-- 只在编辑一个商品的情况下，显示上传图片链接 -->

	<div>
		<div>
			<span>缩略图：</span>
			<empty name="set.logourl"> 
				<span>还没有设置图片</span>
            <else/>
				<img style="width:60px;" src="{ZF:$set.logourl}">
        	</empty>
			<input type="hidden" name="logourl" value="{ZF:$set.logourl}" id="pic">
			<a href="{ZF::U('product_edit_setimage',array('id'=>$set['id'],'token'=>$token, 'catid' => $catid))}">设置图片</a>
	</div>
	
	<div>
		<div>
			<span>展示图片:</span>
			<a href="{ZF::U('product_edit_uploadphotos',array('id'=>$set['id'],'token'=>$token, 'catid' => $catid))}">添加图片</a>
		</div>
		<volist name="imageList" id="vo">
			<div>
			   <img style="width:60px;" src="{ZF:$vo.image}">
			   <input type="hidden" name="image{ZF:$i}" value="{ZF:$vo.image}" imageid="{ZF:$vo.id}" id="image{ZF:$i}">
		    </div>
		</volist>
	</div>

</if>

<div>
图文详细页内容：
<div style="border: 1px solid #666;"><textarea class="toedit" name="intro" id="intro" style="width:100%; height:680px">{ZF:$set.intro}</textarea></div>
</div>

<div>
	<button type="button" name="button" class="btnGreen" id="save">
		<if condition="!empty($_GET['id'])">保存<else/>保存并添加图片</if>
	</button>
	<a href="{ZF::U('Product/index',array('token'=>$token, 'catid' => $catid))}">取消</a>
</div>




	</form>
	
</div>







<script type="text/javascript">
$(document).ready(function(){
	
	
	var oldselect = [];
	
	
	$(".editselect").each(function(){
		var t = $(this).val().split(",");
		//alert(t[0]+'---'+ parseInt(t[1])+'---'+  t[2]+'---'+  t[3]+'---'+  t[4]+'---'+  t[5]+'---'+  t[6]+'---'+  t[7]);
		oldselect[t[1] + '_' + t[3]] = new Array(t[0], t[1], t[2], t[3], t[4], t[5], t[6], t[7]);
	});
	
	// 无论点击了规格还是外观选项，都重新绘制“库存价格列表”
	var render_data = null;
	$(".NormItem").click(function(){
		
		render_data = [];
		
		if ($(".color").length > 0 && $(".norms").length == 0){
		// 只有外观属性
			$(".color").each(function(){
				
				// 设置绘制数据
				if ($(this).is(':checked')){
					
					var color = this;
					var color_id = $(this).val();
					var data_key = color_id+'_0';
					
					if (oldselect[data_key]) {
						render_data[data_key] = oldselect[data_key];
					}else{
						render_data[data_key] = new Array(0,color_id,$(color).attr('atr'),0,'', 0, 0, 0);
					}
				}
			});

		}else if ($(".color").length == 0 && $(".norms").length > 0){
		// 只有规格属性
		
			$(".norms").each(function(){
				console.log(this);
				// 设置绘制数据
				if ($(this).is(':checked')){
					console.log('checked');
					var norm = this;
					var norm_id = $(this).val();
					var data_key = '0_'+norm_id;
					console.log(oldselect[data_key]);
					if (oldselect[data_key]) {
						render_data[data_key] = oldselect[data_key];
					}else{
						render_data[data_key] = new Array(0,0,'',norm_id, $(norm).attr('atr'), 0, 0, 0);
					}
				}
			});
		
		}else if ($(".color").length > 0 && $(".norms").length > 0){
		// 两个属性都有
			$(".color").each(function(){
				
				if ($(this).is(':checked')){
					
					var color = this;
					var color_id = $(this).val();
					
					$(".norms").each(function(){
						
						// 设置绘制数据
						if ($(this).is(':checked')){
							
							var norm = this;
							var norm_id = $(this).val();
							var data_key = color_id+'_'+norm_id;
							
							if (oldselect[data_key]) {
								render_data[data_key] = oldselect[data_key];
							}else{
								render_data[data_key] = new Array(0,color_id, $(color).attr('atr'),norm_id, $(norm).attr('atr'), 0, 0, 0);
							}
						}
					});
				}
			});
		}
		
		reDrawPriceList();
		
	});
	
	
	
	//绘制数据
	function reDrawPriceList(){
		
		var HTML = '<tr><th width="130">产品外观</th><th width="130">产品规格</th><th width="130">价格</th><th width="130">会员价</th><th width="130">数量</th></tr>';
		for (var index in render_data) {
			HTML = HTML + '<tr class="tnorms">
								<td width="130">'+render_data[index][2]+'<input type="hidden" value="'+render_data[index][1]+'"/></td>
								<td width="130">'+render_data[index][4]+'<input type="hidden" value="'+render_data[index][3]+'"/></td>
								<td width="130"><input type="text" class="px" style="width:60px;" value="'+render_data[index][5]+'"/></td>
								<td width="130"><input type="text" class="px" style="width:60px;" value="'+render_data[index][6]+'"/></td>
								<td width="130"><input type="text" class="px" style="width:60px;" value="'+render_data[index][7]+'"/></td>
								<td width="130"><input type="hidden" value="'+render_data[index][0]+'"/></td>
						  </tr>';
		}
		
		$("#priceList").html(HTML);
		
	}
	
	
	
	$("#save").click(function(){
		
		if (CKEDITOR.instances){
			for (instance in CKEDITOR.instances)
			{
				CKEDITOR.instances[instance].updateElement();
			}
		}

		var name = $("#name").val();
		if (name.length < 1) {
			art.dialog({title:'消息提示', ok:true, width:300, height:200, content:'名称不能为空'});
			return false;
		}
		
		var num = $("#num").val();
		if (isNaN(num)) {
			art.dialog({title:'消息提示', ok:true, width:300, height:200, content:'库存应该是为正整数'});
			return false;
		}
		
		var price = $("#price").val();
		var vprice = $("#vprice").val();
		var oprice = $("#oprice").val();
		var mailprice = $("#mailprice").val();
		var keyword = $("#keyword").val();
		var pic = $("#pic").val();
		var intro = $("#intro").val();
		
		var attribute = [];
		var i = 0;
		var str = '';
		$(".attribute").each(function(){
			attribute[i]= {'name':$(this).attr('atr'), 'value':$(this).val(), 'aid':$(this).attr('aid'), 'id':$(this).attr('id')};//new Array($(this).attr('atr'), $(this).val());
			i ++;
		});
		
		var norms = [];
		var i = 0;
		var tnum = 0;
		$(".tnorms").each(function(){
			tnum += parseInt($(this).children('td').eq(3).children('input').val());
			norms[i]= {'color':$(this).children('td').eq(0).children('input').val(), 'format':$(this).children('td').eq(1).children('input').val(), 'price':$(this).children('td').eq(2).children('input').val(), 'vprice':$(this).children('td').eq(3).children('input').val(), 'num':$(this).children('td').eq(4).children('input').val(), 'id':$(this).children('td').eq(5).children('input').val()};
			i ++;
		});
		if (tnum > 0) {
			num = tnum;
		}
		
		//num = num > tnum ? num : tnum;
		var image1 = $("#image1").val();
		var image2 = $("#image2").val();
		var image3 = $("#image3").val();
		var image4 = $("#image4").val();
		var image5 = $("#image5").val();
		var image6 = $("#image6").val();
		var imageid1 = parseInt($("#image1").attr('imageid'));
		var imageid2 = parseInt($("#image2").attr('imageid'));
		var imageid3 = parseInt($("#image3").attr('imageid'));
		var imageid4 = parseInt($("#image4").attr('imageid'));
		var imageid5 = parseInt($("#image5").attr('imageid'));
		var imageid6 = parseInt($("#image6").attr('imageid'));
		var images = [];
		images[0] = {'id':imageid1, 'image':image1};
		images[1] = {'id':imageid2, 'image':image2};
		images[2] = {'id':imageid3, 'image':image3};
		images[3] = {'id':imageid4, 'image':image4};
		images[4] = {'id':imageid5, 'image':image5};
		images[5] = {'id':imageid6, 'image':image6};
		
		var data = {pid:$("#pid").val(),
					name:name,
					num:num,
					price:price,
					vprice:vprice,
					oprice:oprice,
					mailprice:mailprice,
					keyword:keyword,
					pic:pic,
					intro:intro,
					attribute:JSON.stringify(attribute),
					norms:JSON.stringify(norms),
					images:JSON.stringify(images),
					token:'{ZF:$token}',
					catid:'{ZF:$catid}',
					community_catid:$("#community_catid").val()
					};
		
		
		console.log(data);
		
		$.post("{ZF::U('User/Product/productSave')}", data, function(response){
			if (response.error_code == false) {
				alert('保存成功：'+response.msg);
				if ($('#pid').val() == ''){
					// 新增数据
					console.log(response);
					location.href='{ZF::U('product_edit_setimage',array('token'=>$token, 'catid' => $catid))}'+'&id='+response.pid+'&nextstep=setphotos';
				}else{
					// 编辑老数据
					location.href=location.href;
				}
				
			} else {
				console.log(response);
				alert('保存失败：'+response.msg);
			}
			
		},'json');
	});
});
</script> 
<script src="{ZF::STATICS}/plugin_ckeditor/ckeditor.js" type="text/javascript"></script>
<script type="text/javascript">

// This is a check for the CKEditor class. If not defined, the paths must be checked.
if ( typeof CKEDITOR == 'undefined' )
{
	document.write(
		'<strong><span style="color: #ff0000">Error</span>: CKEditor not found</strong>.' +
		'This sample assumes that CKEditor (not included with CKFinder) is installed in' +
		'the "/ckeditor/" path. If you have it installed in a different place, just edit' +
		'this file, changing the wrong paths in the &lt;head&gt; (line 5) and the "BasePath"' +
		'value (line 32).' ) ;
}
else
{
	
	$( document ).ready( function() {
		
		$( '.toedit' ).each(function(){
			var basicConfig = {
				    plugins: 'about,basicstyles,clipboard,floatingspace,list,indentlist,enterkey,entities,link,toolbar,undo,wysiwygarea',
				    removeButtons: 'Anchor,Underline,Strike,Subscript,Superscript',
				    toolbarGroups: [
				      { name: 'document',	   groups: [ 'mode', 'document', 'doctools' ] },
				      { name: 'editing',     groups: [ 'find', 'selection', 'spellchecker' ] },
				      { name: 'forms' },
				      { name: 'basicstyles', groups: [ 'basicstyles', 'cleanup' ] },
				      { name: 'paragraph',   groups: [ 'list', 'indent', 'blocks', 'align' ] },
				      { name: 'links' },
				      { name: 'insert' },
				      { name: 'styles' },
				      { name: 'colors' },
				      { name: 'tools' },
				      { name: 'others' },
				      { name: 'about' }
				    ]
				  };
			CKEDITOR.inline( this,basicConfig );
			//var editor_info = CKEDITOR.replace( this,basicConfig );
			
		});
		
	} );

}

</script>